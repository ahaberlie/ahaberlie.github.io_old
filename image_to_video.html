
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf8">
        <title>HTML5 Images to Video Converter | TechSlides</title>

        <style>
            body {text-align: center;}
            ul {list-style:none;}
            #drag { border: 10px solid black; text-align: center; padding:20px; width: 500px; margin: auto; display: inline-block;}
            #einput {width:400px;}
            #output {margin:20px;}

            #filesinput {
                visibility: collapse;
                width: 0px;
            }
            #output img{
                border: 5px solid #333;
                margin-right: 2px;
            }
            #small label {font-size:14px;}
            #small div {margin:5px 0;}

        </style>
        <script>
        //analytics tag
        
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-941940-28']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
          
        </script>
    </head>
    <body>
	
		<span id="status">Select some images.</span><br><br>

        <div id="drag">
            <!--<button id="fbutton">Select Image(s)</button>
			!-->
            <div id="small">
                <div><label>Length (Frames):</label><input id="Length" type="number" step="1" value="30"></div>
                <!--<div><label>Height:</label><input id="height" type="number" step="1" value="300"></div>
                <div><label>Video Frame Rate:</label><input id="framerate" type="number" step="1" value="15"></div>
				!-->
            </div>
            <button id="createvideo">Create Video</button>
        </div>
        <!--<input type="file" id="filesinput" multiple>
		!-->
        <br>
        <video id="awesome" controls autoplay loop></video>
        <br>

        <a style="display:none" id="download" download="video.webm">Download WebM</a>

        <canvas id="canvas" style="display:none"></canvas>



<script src="whammy.js"></script>
<script>

            /* Drag'n drop stuff */
            var drag = document.getElementById("drag");
            var fbutton = document.getElementById("fbutton");
            var createvideo = document.getElementById("createvideo");
			var videoLength = +document.getElementById("Length").value;
			console.error(videoLength);
            //var files = document.getElementById("filesinput");
            var ctx = 0;

            var canvas = document.getElementById("canvas");
            var context = canvas.getContext("2d");

            //image to video via Whammy
            var video = new Whammy.Video(15);

            var filesarr = [];

            createvideo.addEventListener("click", function() {

                document.getElementById('status').innerHTML = "Working... Please Wait.";

                document.getElementById('awesome').src = "";
                ctx = 0;

                canvas.width = 1280 //document.getElementById("width").value;
                canvas.height = 720 //document.getElementById("height").value;
                video = new Whammy.Video(24); //document.getElementById("framerate").value);

                //if we have images loaded
                if(videoLength>0){

                    //loop through them and process
                    for(i=0; i<videoLength; i++) {
						//var reader = new FileReader();
                        var fileName = "localhost:8080/framez/" + String(5480 - (videoLength - i)) + ".png";
						file = getBase64Image(fileName);
						console.log(file);
                        if(file.type.match(/image.*/)){
                            process(file);
                        } else {
                            document.getElementById('status').innerHTML = "This file does not seem to be a image.";
                        }
                    }

                } else {
                    document.getElementById('status').innerHTML = "Please select some images.";
                }

            }, false);


			function getBase64Image(img) {
				// Create an empty canvas element
				var canvas = document.createElement("canvas");
				canvas.width = img.width;
				canvas.height = img.height;

				// Copy the image contents to the canvas
				var ctx = canvas.getContext("2d");
				ctx.drawImage(img, 0, 0);

				// Get the data-URL formatted image
				// Firefox supports PNG and JPEG. You could check img.src to
				// guess the original format, but be aware the using "image/jpg"
				// will re-encode the image.
				var dataURL = canvas.toDataURL("image/png");

				return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
			}



            //fbutton.addEventListener("click", function() {
            //    document.getElementById('filesinput').click();
            //}, false);

           // drag.ondragover = function(e) {e.preventDefault()}
           // drag.ondrop = function(e) {
           //     e.preventDefault();
           //     filesarr = e.dataTransfer.items;
           //     document.getElementById('status').innerHTML = "Please select options and click on Create Video.";
           // }

            //process files VIA INPUT
            //files.addEventListener("change", function (e) {
            //    filesarr = e.target.files;
            //    document.getElementById('status').innerHTML = "Please select options and click on Create Video.";
           // }, false);



            /* main process function */
            function process(file) {

                var reader = new FileReader();
                reader.onload = function(event) {
                    var dataUri = event.target.result;
                    var img = new Image();
                 
                    //load image and drop into canvas
                    img.onload = function() {

                        //a custom fade in and out slideshow
                        //context.globalAlpha = 0.2;
                        context.drawImage(img, 0, 0, canvas.width, canvas.height);
                        video.add(context);
                        //context.clearRect(0,0,context.canvas.width,context.canvas.height);
                       // context.globalAlpha = 0.4;
                       // context.drawImage(img, 0, 0, canvas.width, canvas.height);
                       // video.add(context);
                       // context.clearRect(0,0,context.canvas.width,context.canvas.height);
                      //  context.globalAlpha = 0.6;
                      //  context.drawImage(img, 0, 0, canvas.width, canvas.height);
                      //  video.add(context);
                      //  context.clearRect(0,0,context.canvas.width,context.canvas.height);
                      //  context.globalAlpha = 0.8;
                     //   context.drawImage(img, 0, 0, canvas.width, canvas.height);
                      //  video.add(context);                       
                     //   context.clearRect(0,0,context.canvas.width,context.canvas.height);
                      //  context.globalAlpha = 1;
                      //  context.drawImage(img, 0, 0, canvas.width, canvas.height);

                        //this should be a loop based on some user input
                       // video.add(context);
                      //  video.add(context);
                      //  video.add(context);
                      //  video.add(context);
                      //  video.add(context);
                      //  video.add(context);
                      //  video.add(context);

                     //   context.clearRect(0,0,context.canvas.width,context.canvas.height);
                     //   context.globalAlpha = 0.8;
                     //   context.drawImage(img, 0, 0, canvas.width, canvas.height);
                     //   video.add(context);
                     //   context.clearRect(0,0,context.canvas.width,context.canvas.height);
                     //   context.globalAlpha = 0.6;
                     //   context.drawImage(img, 0, 0, canvas.width, canvas.height);
                     //   video.add(context);
                     //   context.clearRect(0,0,context.canvas.width,context.canvas.height);
                     //   context.globalAlpha = 0.4;
                     //   context.drawImage(img, 0, 0, canvas.width, canvas.height);
                     //   video.add(context);
                              
                        ctx++;
                        finalizeVideo();

                    };
                    img.src = dataUri;
                };

                reader.onerror = function(event) {
                    console.error("File could not be read! Code " + event.target.error.code);
                };

                reader.readAsDataURL(file);

            }      


function finalizeVideo(){
  //check if its ready
  if(ctx==filesarr.length){

      var start_time = +new Date;
      var output = video.compile();
      var end_time = +new Date;
      var url = webkitURL.createObjectURL(output);

      document.getElementById('awesome').src = url; //toString converts it to a URL via Object URLs, falling back to DataURL
      document.getElementById('download').style.display = '';
      document.getElementById('download').href = url;
      document.getElementById('status').innerHTML = "Compiled Video in " + (end_time - start_time) + "ms, file size: " + Math.ceil(output.size / 1024) + "KB";

  }

}


</script>
</body>
</html>